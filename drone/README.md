## unimatrix drone
the client agent which handles registration, puppet, backups, software updates, etc.

### Drone Status

drone writes out its status for Puppet and backups to files in /etc.

#### Puppet Status

The puppet status file is located at``/etc/soton/state/puppet``

It is a JSON formatted file.  The top level is a dictionary/hash. The possible
keys for the hash are:

- **when:** the time (integer unix timestamp) when the last puppet run was.
- **code:** the status as an integer (see below)
- **output:** a string with human readable information about the current status (this can be null)

The value of 'code' is the output of the 'puppet apply' command, thus it will be
one of:

- **0** Puppet run successful, no files changed
- **1** Puppet run failed
- **2** The run succeeded, some files were changed
- **4** The run succeeded, but some resources failed (thus, overall fail)
- **6** The run succeeded, but included changes and failures (thus, overall fail)
- **other:** assume Puppet failed

##### Example

Here is an example JSON file:

```
{
  "output": "\u001b[1;33mWarning: \/etc\/puppetlabs\/puppet\/hiera.yaml: Use of 'hiera.yaml' version 3 is deprecated. It should be converted to version 5\n   (in \/etc\/puppetlabs\/puppet\/hiera.yaml)\u001b[0m\n\u001b[mNotice: Compiled catalog for uos-213789.clients.soton.ac.uk in environment production in 0.56 seconds\u001b[0m\n\u001b[mNotice: Applied catalog in 2.79 seconds\u001b[0m\n",
  "code": 0,
  "when": 1487162530
}
```

#### Backup Status

The backup status file is located at``/etc/soton/state/backup``

It is a JSON formatted file.  The top level is a dictionary/hash. The possible
keys for the hash are:

- **when:** the time (integer unix timestamp) when the last backup attempt was
- **code:** the status as an integer (see below)
- **output:** a string with human readable information about the current status (this can be null)

The value of 'code' can either be zero (the backup was a success), a negative integer (thus signifying something went wrong before a backup attempt could even be made) or a positive integer (the output of the ssh command):

- **0** Backup completed successfully
- **-1** An error occured when attempting to snapshot the disk before the backup is taken
- **-2** Network manager reported the network was down so no backup attempt was made
- **-3** A backup is currently in progress
- **-4** Backups are disabled on this system
- **1** The backup succeeded but some files were not backed up
- **2** The backup failed, the rsync command on the server returned an error
- **3** The backup failed, a python exception was generated in the server code
- **100** A python exception was raised whilst requesting a backup from the plexus daemon
- **101** A python exception was raised whilst waiting for the plexus backup task to finish
- **102** A python exception was raised whilst asking plexus for the result of the backup
- **other:** the backup failed

When writing an application that queries the status if the code is greater than 1 then its best to just state that the backup failed rather than drill down to every error code. 

**Technical note:** Negative integers are generated by ``drone`` itself (e.g. before running the SSH command which starts the actual backup), integers between 0 and 99 are generated by ``plexus`` itself, and integers between 100 and 200 are generated by the `request-backup` command which communicates with ``plexus``.


##### Example

Here is an example JSON file:

```
{
  "output": null,
  "code": 0,
  "when": 1487115721
}
```
